<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flujo de densidad estelar ‚Äî Colores por valor</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body { 
      background:#000; 
      color:#fff; 
      font-family:Arial, sans-serif; 
      margin:0; 
      padding:20px; 
    }

    h1 { margin-bottom:10px; }

    .controls { 
      display:flex; 
      gap:20px; 
      flex-wrap:wrap; 
      margin-bottom:20px; 
    }

    .control { 
      display:flex; 
      flex-direction:column; 
    }

    label { margin-bottom:5px; }

    #graph { 
      width:100%; 
      height:600px; 
    }

button { 
  margin-right: 10px; 
  padding: 6px 12px; 
  background: #222; 
  color: #fff; 
  border: 1px solid #444; 
  cursor: pointer; 
}

    button:hover { background:#333; }
  </style>
</head>
<body>

  <h1>eduardo parrilla toledano 
    Javier Arriola Rodr√≠guez  ‚Äî Render 3D</h1>
  

  <div class="controls">

    <div class="control">
      <label>Densidad (cantidad de estrellas)</label>
      <input type="range" id="densidad" min="500" max="8000" step="500" value="2000">
      <span id="densidad_val">2000</span>
    </div>

    <div class="control">
      <label>Masa central</label>
      <input type="range" id="masa" min="0.5" max="20" step="0.5" value="1">
      <span id="masa_val">1.0</span>
    </div>

    <div class="control">
      <label>Velocidad angular</label>
      <input type="range" id="omega" min="0" max="5" step="0.1" value="0.4">
      <span id="omega_val">0.4</span>
    </div>

    <div class="control">
      <label>Dispersi√≥n radial</label>
      <input type="range" id="disp" min="0.05" max="2" step="0.05" value="0.15">
      <span id="disp_val">0.15</span>
    </div>

    <div class="control">
      <button id="play">‚ñ∂Ô∏è Play</button>
      <button id="pause">‚è∏Ô∏è Pause</button>
      <button id="reset">üîÑ Reset</button>
    </div>
  </div>

  <div id="graph"></div>

  <script>

    let INIT = { N: 2000, rmax: 15, k:0.35, dt:0.02 };
    let state = { r:[], theta:[], z:[], t:0, playing:false };

    function randn(){ 
      const u=Math.random(), v=Math.random(); 
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); 
    }

    function initStars(){
      state.r=[], state.theta=[], state.z=[];
      for(let i=0;i<INIT.N;i++){
        const r = Math.random()*INIT.rmax;
        const theta = Math.random()*2*Math.PI + INIT.k*r;
        state.r.push(r);
        state.theta.push(theta);
        state.z.push(randn()*0.15);
      }
      state.t=0;
    }

    /* === CAMPO DE VELOCIDADES ESTABILIZADO === */
    function velocityField(r, masa, omega, sigma, t){
      const vt=[], vr=[], vz=[];
      for(let i=0;i<r.length;i++){

        // Velocidad tangencial estabilizada
        vt.push(
          (omega*Math.sqrt(masa)/(1+r[i]/4)) +
          INIT.k*r[i] * 0.8
        );

        // Velocidad radial con freno
        vr.push(
          (-0.08*r[i]/(1+r[i]/4)) +
          randn()*sigma*0.03
        );

        // Restauraci√≥n al plano Z
        vz.push(
          randn()*sigma*0.15 -
          0.015 * state.z[i]
        );
      }
      return {vt, vr, vz};
    }

    function polarToXYZ(r,theta,z){
      const x=[], y=[];
      for(let i=0;i<r.length;i++){
        x.push(r[i]*Math.cos(theta[i]));
        y.push(r[i]*Math.sin(theta[i]));
      }
      return {x,y,z};
    }

    function updateFigure(){
      const masa=parseFloat(document.getElementById("masa").value);
      const omega=parseFloat(document.getElementById("omega").value);
      const sigma=parseFloat(document.getElementById("disp").value);

      const {vt,vr,vz}=velocityField(state.r,masa,omega,sigma,state.t);
      const {x,y,z}=polarToXYZ(state.r,state.theta,state.z);

      // Magnitud de velocidad ‚Üí color
      const vmag = vt.map((v,i)=>Math.sqrt(vt[i]**2 + vr[i]**2 + vz[i]**2));

      Plotly.react("graph",[{
        x,y,z,
        mode:"markers",
        type:"scatter3d",
        marker:{
          size:3,
          color:vmag,
          colorscale:"Rainbow",
          opacity:0.9
        }
      }],{scene:{bgcolor:"#000"},margin:{l:0,r:0,b:0,t:40}});
    }

    function step(){
      const masa=parseFloat(document.getElementById("masa").value);
      const omega=parseFloat(document.getElementById("omega").value);
      const sigma=parseFloat(document.getElementById("disp").value);

      const {vt,vr,vz}=velocityField(state.r,masa,omega,sigma,state.t);

      for(let i=0;i<state.r.length;i++){

        state.theta[i] += vt[i] * INIT.dt * 0.7;
        state.r[i] += vr[i] * INIT.dt;
        state.z[i] += vz[i] * INIT.dt;

        if(state.r[i] < 0.01) state.r[i] = 0.01;

        if(state.r[i] > INIT.rmax){
          state.r[i] = INIT.rmax - Math.random()*0.5;
        }
      }
      state.t+=INIT.dt;
    }

    function animate(){
      if(!state.playing) return;
      step(); updateFigure();
      requestAnimationFrame(animate);
    }

    // CONTROLES
    document.getElementById("play").onclick=()=>{ state.playing=true; animate(); };
    document.getElementById("pause").onclick=()=>{ state.playing=false; };
    document.getElementById("reset").onclick=()=>{ initStars(); updateFigure(); };

    document.querySelectorAll("input").forEach(el=>{
      el.oninput=()=>{
        document.getElementById(el.id+"_val").textContent=el.value;

        if(el.id==="densidad"){
          INIT.N = parseInt(el.value);
          initStars();
        }

        updateFigure();
      };
    });

    initStars(); updateFigure();

  </script>
</body>
</html>


